<html xmlns='http://www.w3.org/1999/xhtml'>
  <head>
    <meta http-equiv='Content-Type' content='text/html; charset=iso-8859-1' />
    <title>fletter - Technomancy</title>
    <script src="/static/prototype.js" type="text/javascript"></script>

    <link href="http://technomancy.us/feed/atom" rel="alternate" type="application/atom+xml"/>
    <link rel='stylesheet' href='/static/style.css' type='text/css' />
  </head>

  <body>

    <div id='background'>
      <img src='/static/i/top.png' alt='Technomancy' border='0' id='corner' />

      <div id='wrapper'> &nbsp;

      <div id='nav'>
        <ul>
          <li><a href='/'>blog</a></li>
          <li><a href='/resume'>r&eacute;sum&eacute;</a></li>
          <li><a href='/contact'>contact</a></li>
          <li><a href='/meta'>meta</a></li>
          <li><a href='http://dev.technomancy.us'>projects</a></li>
        </ul>

      </div><!-- end nav -->

      <p id='tagline'>Any sufficiently advanced technology is indistinguishable from magic.</p>

      <div id='content'>
        <h2>{ blog }</h2><div id='sidebar'>

        <h3>What you say?</h3>

        <p class='explain'>These are the technology musings of Phil
        Hagelberg. I write Ruby and Javascript code for a living, but I also spend a lot of
        time considering how to do so in the most efficient manner. This
        necessarily involves good-sized chunks of Emacs lisp.</p>

        <p class='explain'>I've got a separate <a href="http://philisha.net">blog for
        personal thoughts</a> and a <a href="http://dev.technomancy.us">wiki</a>
        for my projects.</p>

        <form action='http://www.google.com/search' name='searchbox' method='get'>
          <input type='hidden' name='sitesearch' value='technomancy.us' />
          <input type='text' name='q' size='9' value='Search' class='form-text'
                 onfocus="if (this.value=='Search') value='';"
                 onblur="if (this.value=='') value='Search';" />
          <input type='submit' value='&#187;' class='button' title="Because I didn't want to code search myself" />
        </form>

        <p><a href='/feed/atom' title='Syndication is your friend'><img src='/static/i/feedIcon.png' alt='feed' align='left' /> Feed</a></p>

        <h3>Fellow Hackers</h3>
        <ul>
          <li><a href='http://arko.net/' rel='friend met colleague'>andr&eacute; arko</a></li>
          <li><a href='http://brainspl.at' rel='friend met colleague'>ezra Z</a></li>
          <li><a href='http://blog.livollmers.net/' rel='friend colleague met'>alex</a></li>
          <li><a href='http://userprimary.net/user' rel='frient colleague met'>seth</a></li>
          <li><a href='http://www.lathi.net' rel='friend colleague met'>doug alcorn</a></li>
          <li><a href='http://blog.hasmanythrough.com' rel='friend colleague met'>josh susser</a></li>
          <li><a href='http://yehudakatz.com'>katz</a></li>
          <li><a href='http://evil.che.lu' rel='friend colleague'>evilchelu</a></li>
          <li><a href='http://jw.fi' rel='friend colleague'>unfo-</a></li>
          <li><a href='http://metaatem.com' rel='friend colleague met'>kastner</a></li>
          <li><a href='http://www.anarchaia.org/'>anarchaia</a></li>
          <li><a href='http://blog.codahale.com' rel='friend colleague met'>coda hale</a></li>
          <li><a href='http://gilesbowkett.blogspot.com' rel='colleague'>giles bowkett</a></li>
          <li><a href='http://on-ruby.blogspot.com/' rel='colleague met'>pate</a></li>
          <li><a href='http://schneier.com/blog' title='SecurityInsight'>bruce schneier</a></li>
          <li><a href='http://tbray.org/ongoing' rel='met' title='t1m'>tim bray</a></li>
          <li><a href='http://diveintomark.org'>mark pilgrim</a></li>
          <li><a href='http://intertwingly.net'>sam ruby</a></li>
          <li><a href='http://hackety.org' rel='met'>hackety</a></li>
          <li><a href='http://redhanded.hobix.com/' rel='met' title='Lucky Stiff and Friends'>redHanded</a></li>
          <li><a href='http://eigenclass.org' title="maybe if i read this more often i'll get smarter and understand it">mauricio</a></li>
          <li><a href='http://onestepback.org' title='the santa claus of Ruby'>jim weirich</a></li>
          <li><a href='http://ejohn.org'>john resig</a></li>
          <li><a href='http://steve-yegge.blogspot.com/' title='mostly he is listed because of emacs'>steve yegge</a></li>
        </ul>

        <h3 title='aggregation is key here'>Communities</h3>
        <ul>
          <li><a href='http://planet.lisp.org' title="(grok 'lisp)">planet lisp</a></li>
          <li><a href='http://planet.emacsen.org' title='denizens of #emacs'>planet emacs</a></li>
          <li><a href='http://planetruby.0x42.net' title='Yes, it runs on Python'>planet ruby</a></li>
          <li><a href='http://planet.caboo.se' title='my latest planet'>planet caboose</a></li>
          <li><a href='http://planet.ubuntu.com' title='humanity'>planet ubuntu</a></li>
          <li><a href='http://planet.mozilla.org' title='Gecko will save us'>planet mozilla</a></li>
          <li><a href='http://radar.oreilly.com/' title='there are those that call me... tim'>planet o'reilly</a></li>
        </ul>

        <h3><a href='http://dev.technomancy.us/'>Projects</a></h3>
        <ul>
          <li><a href='http://bus-scheme.rubyforge.org'>bus scheme</a></li>
          <li><a href='http://augment.rubyforge.org'>augment</a></li>
          <li><a href='http://www.emacswiki.org/cgi-bin/wiki/ElUnit' title='Emacs Lisp TDD'>elunit</a></li>
          <li><a href='http://rinari.rubyforge.org' title='rails emacs mode'>rinari</a></li>
          <li><a href='http://concour.se' title='railsday 06 project'>Concourse</a></li>
          <li><a href='http://rubyforge.org/projects/rplanet' title='Feed Aggregator'>rPlanet</a></li>
          <li><a href='http://rav.rubyforge.org/' title='Rails Application Visualizer'>rav</a></li>
          <li><a href='http://cartographer.rubyforge.org' title='Google Maps in Rails'>Cartographer</a></li>
          <li><a href='http://dev.technomancy.us/ebby' title='collaborative editing with Emacs'>ebby</a></li>
        </ul>

      </div><!-- end sidebar -->

      <div class='post'>
        <h3><a href='/94'>fletter</a></h3>

        <div>
          <p>
  One of the handy things about Lisp that I've gotten attached to is
  the <tt>flet</tt> function. Using it you can temporarily redefine a
  function but have its definition revert back to the original when
  its body exits. This is analagous to the way a block in Ruby can
  have some specific behaviour that goes away when it exits,
  but <tt>flet</tt> doesn't seem to have a Ruby equivalent. (The
  best my searches found was pstickne enlightening folks in
  #ruby-lang about this lisptastic functionality.) Anyway, I just figured out an implementation.
</p>

<pre class="code">
<span class="keyword">def</span> <span class="function-name">Object.flet</span>(bindings, &amp;block)
  old_methods = {}

  bindings.each <span class="keyword">do</span> |the_method, body|
    old_methods[the_method] = method(the_method)
    define_method(the_method, body)
  <span class="keyword">end</span>
  
  <span class="keyword">begin</span>
    block.call
  <span class="keyword">ensure</span>
    bindings.each <span class="keyword">do</span> |the_method, body|
      define_method(the_method) { |*args| old_methods[the_method].call(*args) }
    <span class="keyword">end</span>
  <span class="keyword">end</span>
<span class="keyword">end</span>
</pre>

<p>This lets you do stuff like:</p>

<pre class="code">
puts <span class="string">"foo"</span>

<span class="type">Object</span>.flet(<span class="constant">:puts</span> =&gt; &lambda; { |str| print <span class="string">"</span><span class="variable-name">#{str.reverse}</span><span class="string">\n"</span> }) <span class="keyword">do</span>
  puts <span class="string">"foo"</span>
<span class="keyword">end</span>

puts <span class="string">"foo"</span>
</pre>

<p>... which will output:</p>

<pre class="code">foo
oof
foo</pre>

<p>Pretty cool, huh? I haven't done much funky metaprogramming in
  Ruby, so it's quite possible my attempts to Lispify it here are
  dangerous and/or misguided. (That's what comments are for, BTW.) But
  it's coming in pretty handy for me so far.</p>

<p><b>Update</b>: <a href='http://blog.hasmanythrough.com'>Josh</a>
  points out that this is not thread-safe and thoroughly violates
  encapsulation in a way that should earn me a severe thrashing (dare I say&mdash;flogging?) were I
  to use it in production in anything but the simplest of circumstances. In my mind
  it's kind of like using <tt>eval</tt>: all advice concerning
  actually using it goes along the lines of "never do this". Only once
  you learn when it's OK to ignore such strong warnings can you be
  trusted to posess the necessary discretion to use it in
  practice.</p>

<p>The context here is that I want to run a bunch of tests and gather
  failure data within my library. But when I require <tt>test/unit</tt>, it sets up an
  <a href="http://www.ruby-doc.org/core/classes/Kernel.html#M005957">at_exit</a>
  block that actually initiates the running of the tests as a final act before the execution finishes. This is
  redundant since I already initiated them myself in the library. But
  once you've created an <tt>at_exit</tt>, there's no mechanism for
  disabling it. I could just redefine <tt>at_exit</tt> permanently,
  but it's quite possible I'd want to use it elsewhere. <tt>flet</tt>
  allows me to limit the scope of this change. But it's only
  forgivable because I'm not really working with an object-oriented
  phenomenon here; I'm working with a lower-level feature of Ruby.</p>

<pre class="code">
<span class="type">Object</span>.flet(<span class="constant">:at_exit</span> =&gt; lambda {}) <span class="keyword">do</span>
  <span class="comment-delimiter"># </span><span class="comment">keep test/unit's at_exit block from running</span>
  require <span class="string">'test/unit'</span>
<span class="keyword">end</span>
</pre>

<p>And as Josh notes, Rubinius will make stuff like this much easier. I imagine I wouldn't even have to resort to <tt>flet</tt> to get around my <tt>at_exit</tt> problem.</p>
        </div>

        <p class='dt'>
          <a href='/94'>Sat Oct 13 00:00:01 -0700 2007</a>
        </p>
      </div>
    </div>

    <p id='foot'>
      &copy; 2004 - 2007 Phil Hagelberg <span title='soli Deo gloria'>SDG</span>
    </p>

  </div><!-- end wrapper -->
  <img src='/static/i/foot.png' alt='' id='corner' style='display: block;' />

</div><!-- end background -->


</body></html>
